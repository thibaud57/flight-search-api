# ğŸ“‹ Plan de Refactoring - Transmission Plan Complet aux Agents

**Date** : 2025-11-19
**Objectif** : Corriger la perte d'information (Points d'Attention, CritÃ¨res Validation Finale) dans le workflow
**Solution** : Passer `plan_details` (plan markdown complet) Ã  tous les agents
**Approche** : Hybride - Workflow parse metadata + agents reÃ§oivent plan complet

---

## ğŸ¯ ProblÃ¨me IdentifiÃ©

### Informations perdues actuellement

```
Agent PLAN gÃ©nÃ¨re :
â”œâ”€â”€ âœ… Objectif
â”œâ”€â”€ âœ… Agent d'ExÃ©cution
â”œâ”€â”€ âœ… StratÃ©gie
â”œâ”€â”€ âœ… Checklist Niveau 2        â†’ Transmis âœ…
â”œâ”€â”€ âŒ Points d'Attention        â†’ PERDU âŒ
â””â”€â”€ âŒ CritÃ¨res Validation Finale â†’ PERDU âŒ

Workflow transmet :
â”œâ”€â”€ CODE/DOCUMENT : checklist_niveau_2 uniquement
â””â”€â”€ TEST : checklist_niveau_1 + checklist_niveau_2 uniquement
```

**Impact** :
- Agents CODE/DOCUMENT ne voient pas les risques/contraintes
- Agent TEST ne peut pas valider critÃ¨res globaux
- Validations incomplÃ¨tes

---

## âœ… Solution Retenue : Option Hybride

### Principe

**Workflow** (execute-plan-phase.md) :
- Parse **uniquement** metadata nÃ©cessaires pour orchestration :
  - `document_type` : Pour savoir quel template (si agent=DOCUMENT)
  - `strategie` : Pour savoir combien d'agents lancer (UNIQUE vs PARALLÃˆLE)
- Stocke plan complet dans variable : `plan_details`
- Passe `plan_details` Ã  tous les agents

**Agents** (CODE/DOCUMENT/TEST) :
- ReÃ§oivent `plan_details` (plan markdown complet) en contexte
- Lisent ce dont ils ont besoin SANS parsing complexe
- AccÃ¨s total au contexte (checklist, points attention, critÃ¨res)

### Avantages

âœ… **Aucune perte d'information** : Plan complet transmis
âœ… **Parsing minimal** : Workflow extrait juste orchestration metadata
âœ… **Agents autonomes** : Lisent plan comme un humain (pas de parsing code)
âœ… **Ã‰volutif** : Ajouter sections au plan ne casse pas le workflow
âœ… **DRY** : Pas de duplication de parsing entre agents

---

## ğŸ“ Plan de Refactoring DÃ©taillÃ©

### Fichier 1 : `.claude/commands/execute-plan-phase.md`

#### Changement 1.1 : Ã‰TAPE 5 - Parsing simplifiÃ© (lignes 296-327)

**AVANT** :
```markdown
**Parser le plan validÃ© pour extraire les donnÃ©es nÃ©cessaires** :

1. **Extraire `checklist_niveau_2`** :
   - Rechercher section `## ğŸ“ Checklist Niveau 2`
   - **Pour chaque Ã©tape numÃ©rotÃ©e, inclure la ligne critÃ¨re succÃ¨s indentÃ©e**
   - [... parsing complexe ...]
   - Stocker dans `checklist_niveau_2` (liste de strings)

2. **Extraire `document_type`** (si agent=DOCUMENT) :
   - Rechercher section `## ğŸ¤– Agent d'ExÃ©cution`
   - Ligne `**Type document** : [specs|references|docs]`
   - Stocker dans variable `document_type`

3. **Extraire stratÃ©gie** :
   - Rechercher section `## ğŸš€ StratÃ©gie`
   - Ligne `**ExÃ©cution** : [UNIQUE|PARALLÃˆLE]`
   - Si PARALLÃˆLE : extraire division des agents
```

**APRÃˆS** :
```markdown
**Stocker et parser metadata orchestration** :

1. **Stocker plan complet** :
   - Variable `plan_details` = plan markdown complet retournÃ© par agent PLAN
   - Ce plan sera transmis intÃ©gralement aux agents d'exÃ©cution et de validation

2. **Extraire metadata orchestration** (parsing minimal pour workflow uniquement) :

   **a) DÃ©terminer agent d'exÃ©cution** :
   - Rechercher section `## ğŸ¤– Agent d'ExÃ©cution`
   - Ligne `**Agent** : [CODE|DOCUMENT]`
   - Stocker dans variable `agent_type`

   **b) Extraire `document_type`** (si agent=DOCUMENT) :
   - Ligne `**Type document** : [specs|references|docs]`
   - Stocker dans variable `document_type`

   **c) Extraire stratÃ©gie d'exÃ©cution** :
   - Rechercher section `## ğŸš€ StratÃ©gie`
   - Ligne `**ExÃ©cution** : [UNIQUE|PARALLÃˆLE]`
   - Stocker dans variable `strategie`

   **d) Si PARALLÃˆLE** :
   - Ligne `**Nombre d'agents** : [N agents]`
   - Ligne `**Division** : [description division]`
   - Stocker division pour orchestration
```

**Raison** : Workflow parse uniquement ce dont IL a besoin pour orchestrer. Le plan complet est transmis aux agents qui le liront naturellement.

---

#### Changement 1.2 : Ã‰TAPE 6 - Prompts agents CODE/DOCUMENT (lignes 359-415)

**AVANT** (Cas PARALLÃˆLE - agent CODE) :
```markdown
Task(subagent_type="code", prompt="""
ImplÃ©menter partie {N} :

**Checklist** : {sous-checklist_N}
**Contexte codebase** : {codebase}
**Fichiers documentation** : {documentation_files}
**Output** : {expected_output}

ExÃ©cuter strictement la checklist, respecter conventions projet.
""")
```

**APRÃˆS** (Cas PARALLÃˆLE - agent CODE) :
```markdown
Task(subagent_type="code", prompt="""
ImplÃ©menter partie {N} du plan d'implÃ©mentation :

**Plan d'implÃ©mentation** :
{plan_details}

**Ta checklist assignÃ©e** :
{sous-checklist_N}

**Contexte codebase** : {codebase}
**Fichiers documentation** : {documentation_files}

**Instructions** :
1. Lire le plan complet pour comprendre le contexte global
2. ImplÃ©menter UNIQUEMENT ta checklist assignÃ©e (Ã©tapes {start}-{end})
3. Respecter les Points d'Attention mentionnÃ©s dans le plan
4. Viser les CritÃ¨res de Validation Finale du plan
5. Respecter conventions projet (codebase)

âš ï¸ Ne pas implÃ©menter les Ã©tapes des autres agents (si parallÃ¨le).
""")
```

**AVANT** (Cas PARALLÃˆLE - agent DOCUMENT) :
```markdown
Task(subagent_type="document", prompt="""
RÃ©diger partie {N} :

**Type** : {document_type}
**Checklist** : {sous-checklist_N}
**Fichiers documentation** : {documentation_files}
**Output** : {expected_output}

Suivre strictement template {TEMPLATE_SPECS.md | TEMPLATE_REFERENCES.md | TEMPLATE.md}.
""")
```

**APRÃˆS** (Cas PARALLÃˆLE - agent DOCUMENT) :
```markdown
Task(subagent_type="document", prompt="""
RÃ©diger partie {N} du plan d'implÃ©mentation :

**Plan d'implÃ©mentation** :
{plan_details}

**Ta checklist assignÃ©e** :
{sous-checklist_N}

**Type document** : {document_type}
**Fichiers documentation** : {documentation_files}

**Instructions** :
1. Lire le plan complet pour comprendre le contexte global
2. RÃ©diger UNIQUEMENT ta partie assignÃ©e (Ã©tapes {start}-{end})
3. Respecter les Points d'Attention mentionnÃ©s dans le plan
4. Viser les CritÃ¨res de Validation Finale du plan
5. Suivre template {TEMPLATE_SPECS.md | TEMPLATE_REFERENCES.md | TEMPLATE.md}

âš ï¸ Ne pas rÃ©diger les parties des autres agents (si parallÃ¨le).
""")
```

**AVANT** (Cas UNIQUE - agent CODE) :
```markdown
Task(subagent_type="code", prompt="""
ImplÃ©menter phase complÃ¨te :

**Checklist** : {checklist_niveau_2}
**Contexte codebase** : {codebase}
**Fichiers documentation** : {documentation_files}
**Output** : {expected_output}

ExÃ©cuter strictement la checklist, respecter conventions projet.
""")
```

**APRÃˆS** (Cas UNIQUE - agent CODE) :
```markdown
Task(subagent_type="code", prompt="""
ImplÃ©menter phase complÃ¨te selon plan d'implÃ©mentation :

**Plan d'implÃ©mentation** :
{plan_details}

**Contexte codebase** : {codebase}
**Fichiers documentation** : {documentation_files}

**Instructions** :
1. Lire le plan complet (Objectif, Checklist, Points d'Attention, CritÃ¨res Validation)
2. ImplÃ©menter TOUTES les Ã©tapes de la checklist niveau 2 dans l'ordre
3. Respecter les Points d'Attention mentionnÃ©s dans le plan
4. Viser les CritÃ¨res de Validation Finale du plan
5. Respecter conventions projet (codebase)
""")
```

**AVANT** (Cas UNIQUE - agent DOCUMENT) :
```markdown
Task(subagent_type="document", prompt="""
RÃ©diger documentation complÃ¨te :

**Type** : {document_type}
**Checklist** : {checklist_niveau_2}
**Fichiers documentation** : {documentation_files}
**Output** : {expected_output}

Suivre strictement template {TEMPLATE_SPECS.md | TEMPLATE_REFERENCES.md | TEMPLATE.md}.
""")
```

**APRÃˆS** (Cas UNIQUE - agent DOCUMENT) :
```markdown
Task(subagent_type="document", prompt="""
RÃ©diger documentation complÃ¨te selon plan d'implÃ©mentation :

**Plan d'implÃ©mentation** :
{plan_details}

**Type document** : {document_type}
**Fichiers documentation** : {documentation_files}

**Instructions** :
1. Lire le plan complet (Objectif, Checklist, Points d'Attention, CritÃ¨res Validation)
2. RÃ©diger TOUTES les sections de la checklist niveau 2 dans l'ordre
3. Respecter les Points d'Attention mentionnÃ©s dans le plan
4. Viser les CritÃ¨res de Validation Finale du plan
5. Suivre template {TEMPLATE_SPECS.md | TEMPLATE_REFERENCES.md | TEMPLATE.md}
""")
```

**Raison** : Agents reÃ§oivent plan complet pour contexte global + checklist assignÃ©e pour savoir quoi faire.

---

#### Changement 1.3 : Ã‰TAPE 7 - Prompt agent TEST (lignes 433-463)

**AVANT** :
```markdown
Task(
  subagent_type="test",
  description="Validation implÃ©mentation",
  prompt="""
  Valider l'implÃ©mentation rÃ©alisÃ©e :

  **Checklist Niveau 1 (PLAN.md - Macro)** :
  {checklist_niveau_1}

  **Checklist Niveau 2 (DÃ©taillÃ©e - PLAN)** :
  {checklist_niveau_2}

  **Output attendu** :
  {expected_output}

  **Contexte codebase** :
  {codebase}

  **Rapports d'implÃ©mentation** :
  {implementation_report}

  VÃ©rifier (PRIORITÃ‰ STRICTE) :
  1. **PRIORITÃ‰ 1 : Checklist niveau 1** (chemins fichiers exacts, outputs macro)
  2. **PRIORITÃ‰ 2 : Checklist niveau 2** (contenu dÃ©taillÃ©, qualitÃ©)
  3. **PRIORITÃ‰ 3 : Tests techniques** (selon type output)

  âš ï¸ IMPORTANT : Si niveau 1 FAIL â†’ ARRÃŠTER, ne pas valider niveau 2

  Retourner rapport validation avec les 2 checklists.
  """
)
```

**APRÃˆS** :
```markdown
Task(
  subagent_type="test",
  description="Validation implÃ©mentation",
  prompt="""
  Valider l'implÃ©mentation rÃ©alisÃ©e selon le plan d'implÃ©mentation :

  **Checklist Niveau 1 (PLAN.md - Macro)** :
  {checklist_niveau_1}

  **Plan d'implÃ©mentation complet** :
  {plan_details}

  **Contexte codebase** :
  {codebase}

  **Rapports d'implÃ©mentation** :
  {implementation_report}

  **Instructions de validation** :

  1. Lire le plan complet pour comprendre :
     - Checklist Niveau 2 (critÃ¨res dÃ©taillÃ©s par Ã©tape)
     - Points d'Attention (risques/contraintes Ã  vÃ©rifier en prioritÃ©)
     - CritÃ¨res de Validation Finale (objectifs globaux de rÃ©ussite)

  2. VÃ©rifier conformitÃ© selon PRIORITÃ‰ STRICTE :
     - **PRIORITÃ‰ 1** : Checklist Niveau 1 (chemins fichiers exacts, outputs macro)
     - **PRIORITÃ‰ 2** : Checklist Niveau 2 (contenu dÃ©taillÃ©, critÃ¨res succÃ¨s par Ã©tape)
     - **PRIORITÃ‰ 3** : CritÃ¨res de Validation Finale (objectifs globaux du plan)
     - **PRIORITÃ‰ 4** : Tests techniques (selon type output + stack)

  3. Tenir compte des Points d'Attention du plan lors de la validation

  âš ï¸ IMPORTANT : Si niveau 1 FAIL â†’ ARRÃŠTER, ne pas valider niveaux suivants

  Retourner rapport validation complet (3 niveaux de validation).
  """
)
```

**Raison** : Agent TEST reÃ§oit plan complet pour valider TOUS les critÃ¨res (niveau 1, niveau 2, critÃ¨res globaux, points attention).

---

### Fichier 2 : `.claude/agents/code.md`

#### Changement 2.1 : Section "RÃ©ception Contexte" (lignes 14-20)

**AVANT** :
```markdown
## ğŸ” RÃ©ception Contexte

**Tu reÃ§ois dans le prompt :**
- `checklist` : Checklist dÃ©taillÃ©e validÃ©e par user (liste de strings multi-ligne avec action + critÃ¨re succÃ¨s)
- `codebase` : Info stack/structure (stack, conventions, existing_files)
- `documentation_files` : Liste fichiers documentation pertinents (utilise Read() pour les lire)
- `expected_output` : Output attendu
```

**APRÃˆS** :
```markdown
## ğŸ” RÃ©ception Contexte

**Tu reÃ§ois dans le prompt :**
- `plan_details` : Plan d'implÃ©mentation complet (markdown) contenant :
  - Objectif global
  - Checklist Niveau 2 (Ã©tapes dÃ©taillÃ©es avec critÃ¨res succÃ¨s)
  - Points d'Attention (risques/contraintes importantes)
  - CritÃ¨res de Validation Finale (objectifs globaux de rÃ©ussite)
- `checklist` (optionnel) : Sous-checklist assignÃ©e si stratÃ©gie PARALLÃˆLE
- `codebase` : Info stack/structure (stack, conventions, existing_files)
- `documentation_files` : Liste fichiers documentation pertinents (utilise Read() pour les lire)
```

#### Changement 2.2 : Section "Process" - Analyse & PrÃ©paration (lignes 54-59)

**AVANT** :
```markdown
### 1. Analyse & PrÃ©paration

**Avant de commencer** :
- Lire checklist complÃ¨te + identifier dÃ©pendances entre Ã©tapes
- Read() fichiers `documentation_files` si fournis
- DÃ©tecter stack depuis `codebase.stack` pour adapter syntaxe/commandes
- VÃ©rifier faisabilitÃ© (outils nÃ©cessaires disponibles)
```

**APRÃˆS** :
```markdown
### 1. Analyse & PrÃ©paration

**Avant de commencer** :
- Lire `plan_details` complet pour comprendre :
  - Objectif global de la phase
  - Checklist Niveau 2 complÃ¨te (ou ta sous-checklist assignÃ©e)
  - Points d'Attention (risques/contraintes Ã  anticiper)
  - CritÃ¨res de Validation Finale (objectifs Ã  viser)
- Identifier dÃ©pendances entre Ã©tapes de la checklist
- Read() fichiers `documentation_files` si fournis
- DÃ©tecter stack depuis `codebase.stack` pour adapter syntaxe/commandes
- VÃ©rifier faisabilitÃ© (outils nÃ©cessaires disponibles)
```

#### Changement 2.3 : Section "Process" - ExÃ©cution (ligne 63-67)

**AVANT** :
```markdown
### 2. ExÃ©cution SÃ©quentielle

**Pour chaque Ã©tape de la checklist** :
1. Lire action + dÃ©tails + critÃ¨re de succÃ¨s
2. ExÃ©cuter avec tools appropriÃ©s (Write, Edit, Bash)
3. Respecter dÃ©tails spÃ©cifiÃ©s + standards projet
4. VÃ©rifier critÃ¨re succÃ¨s avant de passer Ã  la suivante
```

**APRÃˆS** :
```markdown
### 2. ExÃ©cution SÃ©quentielle

**Pour chaque Ã©tape de la checklist** (depuis `plan_details`) :
1. Lire action + dÃ©tails + critÃ¨re de succÃ¨s
2. VÃ©rifier Points d'Attention pertinents pour cette Ã©tape
3. ExÃ©cuter avec tools appropriÃ©s (Write, Edit, Bash)
4. Respecter dÃ©tails spÃ©cifiÃ©s + standards projet + Points d'Attention
5. VÃ©rifier critÃ¨re succÃ¨s avant de passer Ã  la suivante
```

#### Changement 2.4 : Section "QualitÃ© & Validation" (aprÃ¨s ligne 76)

**AJOUTER APRÃˆS ligne 78** :
```markdown
2. **VÃ©rifier CritÃ¨res de Validation Finale** (depuis `plan_details`) :
   - Relire section "âœ… CritÃ¨res de Validation Finale" du plan
   - VÃ©rifier que TOUS les critÃ¨res globaux sont respectÃ©s
   - Signaler dans rapport si un critÃ¨re n'est pas atteignable
```

---

### Fichier 3 : `.claude/agents/document.md`

#### Changement 3.1 : Section "RÃ©ception Contexte" (lignes 14-19)

**AVANT** :
```markdown
## ğŸ” RÃ©ception Contexte

**Tu reÃ§ois dans le prompt :**
- `type` : Type de document ("specs" | "references" | "docs")
- `checklist` : Checklist dÃ©taillÃ©e validÃ©e par user (liste de strings multi-ligne avec action + critÃ¨re succÃ¨s)
- `documentation_files` : Liste fichiers documentation pertinents (utilise Read() pour les lire)
- `expected_output` : Output attendu
```

**APRÃˆS** :
```markdown
## ğŸ” RÃ©ception Contexte

**Tu reÃ§ois dans le prompt :**
- `plan_details` : Plan d'implÃ©mentation complet (markdown) contenant :
  - Objectif global
  - Type document (specs/references/docs)
  - Checklist Niveau 2 (sections Ã  rÃ©diger avec critÃ¨res succÃ¨s)
  - Points d'Attention (risques/contraintes importantes)
  - CritÃ¨res de Validation Finale (objectifs globaux de rÃ©ussite)
- `type` : Type de document explicite ("specs" | "references" | "docs")
- `checklist` (optionnel) : Sous-checklist assignÃ©e si stratÃ©gie PARALLÃˆLE
- `documentation_files` : Liste fichiers documentation pertinents (utilise Read() pour les lire)
```

#### Changement 3.2 : Section "Process de RÃ©daction" - Analyse (lignes 85-91)

**AVANT** :
```markdown
### 1. Analyse & PrÃ©paration

**Avant de commencer** :
1. Identifier `type` reÃ§u
2. Lire checklist complÃ¨te
3. Read() `documentation_files` si fournis
4. Adapter comportement selon type
```

**APRÃˆS** :
```markdown
### 1. Analyse & PrÃ©paration

**Avant de commencer** :
1. Lire `plan_details` complet pour comprendre :
   - Objectif global de la documentation
   - Type document et template associÃ©
   - Checklist Niveau 2 complÃ¨te (ou ta sous-checklist assignÃ©e)
   - Points d'Attention (risques/contraintes Ã  anticiper)
   - CritÃ¨res de Validation Finale (objectifs Ã  viser)
2. Identifier `type` reÃ§u (specs/references/docs)
3. Read() `documentation_files` si fournis
4. Adapter comportement selon type
```

#### Changement 3.3 : Section "Validation QualitÃ©" (aprÃ¨s ligne 123)

**AJOUTER APRÃˆS "Pour type: specs"** :
```markdown
**Pour TOUS les types** (aprÃ¨s validation type spÃ©cifique) :
- âœ… Respecte Points d'Attention du plan
- âœ… RÃ©pond aux CritÃ¨res de Validation Finale du plan
```

---

### Fichier 4 : `.claude/agents/test.md`

#### Changement 4.1 : Section "Contexte d'exÃ©cution" (lignes 17-24)

**AVANT** :
```markdown
## ğŸ“¥ Contexte d'exÃ©cution

**Tu reÃ§ois** :
- `checklist_niveau_1` : Checklist macro (PLAN.md - liste de strings bruts, peut contenir chemins fichiers entre backticks)
- `checklist_niveau_2` : Checklist dÃ©taillÃ©e (PLAN agent - liste de strings multi-ligne avec action + critÃ¨re succÃ¨s indentÃ©)
- `expected_output` : Output attendu
- `codebase` : Stack et conventions (test_runner, linter, type_checker)
- `implementation_report` : Fichiers crÃ©Ã©s/modifiÃ©s (rapport agent CODE/DOCUMENT)
```

**APRÃˆS** :
```markdown
## ğŸ“¥ Contexte d'exÃ©cution

**Tu reÃ§ois** :
- `checklist_niveau_1` : Checklist macro (PLAN.md - liste de strings bruts, peut contenir chemins fichiers entre backticks)
- `plan_details` : Plan d'implÃ©mentation complet (markdown) contenant :
  - Checklist Niveau 2 (Ã©tapes dÃ©taillÃ©es avec critÃ¨res succÃ¨s)
  - Points d'Attention (risques/contraintes Ã  vÃ©rifier en prioritÃ©)
  - CritÃ¨res de Validation Finale (objectifs globaux de rÃ©ussite)
- `codebase` : Stack et conventions (test_runner, linter, type_checker)
- `implementation_report` : Fichiers crÃ©Ã©s/modifiÃ©s (rapport agent CODE/DOCUMENT)
```

#### Changement 4.2 : Section "Process" - Ã‰TAPE 1 (aprÃ¨s ligne 56)

**AJOUTER APRÃˆS ligne 56** :
```markdown
**Note** : La checklist_niveau_2 sera extraite depuis `plan_details` (section `## ğŸ“ Checklist Niveau 2`).
```

#### Changement 4.3 : Section "Process" - Ã‰TAPE 2 (aprÃ¨s ligne 57)

**REMPLACER "Ã‰TAPE 2 : Validation Checklist Niveau 2 (DÃ‰TAIL)"** par :
```markdown
**Ã‰TAPE 2 : Validation Checklist Niveau 2 (DÃ‰TAIL)**

**PrÃ©-requis** : Niveau 1 âœ… PASS

**Extraire checklist_niveau_2 depuis `plan_details`** :
- Rechercher section `## ğŸ“ Checklist Niveau 2`
- Parser toutes les Ã©tapes numÃ©rotÃ©es avec leurs critÃ¨res succÃ¨s

Pour chaque Ã©tape de checklist_niveau_2 :
1. Extraire l'action (premiÃ¨re ligne commenÃ§ant par `N. **...** :`)
2. Extraire le critÃ¨re de succÃ¨s (ligne indentÃ©e `- CritÃ¨re succÃ¨s : ...`)
3. VÃ©rifier critÃ¨re de succÃ¨s respectÃ©
4. Croiser avec rapport d'implÃ©mentation
5. Marquer âœ… ou âŒ
```

#### Changement 4.4 : Ajouter Ã‰TAPE 2.5 (NOUVELLE)

**AJOUTER APRÃˆS Ã‰TAPE 2** :
```markdown
**Ã‰TAPE 2.5 : Validation CritÃ¨res Globaux**

**PrÃ©-requis** : Niveau 1 âœ… PASS + Niveau 2 âœ… PASS

**Extraire critÃ¨res depuis `plan_details`** :
- Rechercher section `## âœ… CritÃ¨res de Validation Finale`
- Parser tous les critÃ¨res globaux listÃ©s

Pour chaque critÃ¨re de validation finale :
1. Comprendre le critÃ¨re global
2. VÃ©rifier si le critÃ¨re est respectÃ© (croiser avec implementation_report + fichiers)
3. Marquer âœ… ou âŒ

**RÃ©sultat** :
- Si AU MOINS 1 critÃ¨re âŒ FAIL â†’ Avertissement (pas bloquant si niveaux 1+2 OK)
- Si TOUS critÃ¨res âœ… â†’ Bonus qualitÃ©
```

#### Changement 4.5 : Section "Process" - Ã‰TAPE 3 (renommer en Ã‰TAPE 3)

**RENOMMER "Ã‰TAPE 3 : DÃ©tection Type & Tests Techniques"** â†’ Garder inchangÃ© mais numÃ©roter Ã‰TAPE 3

#### Changement 4.6 : Section "GÃ©nÃ©ration Rapport" (lignes 142-224)

**AJOUTER dans format rapport APRÃˆS "## âœ… ConformitÃ© Checklist Niveau 2"** :
```markdown
---

## âœ… ConformitÃ© CritÃ¨res de Validation Finale

[**Si niveau 1 + 2 âŒ FAIL** : Section skippÃ©e avec message "â­ï¸ VALIDATION SKIPPÃ‰E (niveaux 1 ou 2 Ã©chouÃ©s)"]

[**Si niveau 1 + 2 âœ… PASS** :]

| # | CritÃ¨re Global | ImplÃ©mentÃ© | Status |
|---|----------------|------------|--------|
| 1 | [CritÃ¨re final] | âœ… OK / âŒ NON | âœ… / âŒ |
| K | [CritÃ¨re] | [RÃ©sultat] | âœ… / âŒ |

**RÃ©sultat CritÃ¨res Globaux** : âœ… PASS (K/K critÃ¨res validÃ©s) | âš ï¸ WARNINGS (X critÃ¨res non respectÃ©s)

---
```

#### Changement 4.7 : Section "Exemple" (lignes 228-302)

**MODIFIER input exemple** (ligne 241-245) :
```markdown
**AVANT** :
checklist_niveau_2: [
  "1. **CrÃ©er fichier** : docs/specs/story-5.md avec metadata YAML\n   - CritÃ¨re succÃ¨s : Fichier crÃ©Ã© avec frontmatter valide",
  "2. **RÃ©diger section CombinationGenerator** : Algorithme complet\n   - CritÃ¨re succÃ¨s : Section prÃ©sente et dÃ©taillÃ©e"
]

**APRÃˆS** :
plan_details: """
# ğŸ“‹ Plan d'ImplÃ©mentation

## ğŸ¯ Objectif
CrÃ©er spÃ©cifications Story 5 avec CombinationGenerator et SearchService.

## ğŸ“ Checklist Niveau 2 (2 Ã©tapes)

1. **CrÃ©er fichier** : docs/specs/story-5.md avec metadata YAML
   - CritÃ¨re succÃ¨s : Fichier crÃ©Ã© avec frontmatter valide

2. **RÃ©diger section CombinationGenerator** : Algorithme complet
   - CritÃ¨re succÃ¨s : Section prÃ©sente et dÃ©taillÃ©e

## ğŸ” Points d'Attention
- Respecter template TEMPLATE_SPECS.md strictement

## âœ… CritÃ¨res de Validation Finale
- Fichier complet et structurÃ© selon template
- MÃ©tadata YAML valide
"""
```

**AJOUTER dans rapport exemple APRÃˆS "ConformitÃ© Checklist Niveau 2"** :
```markdown
---

## âœ… ConformitÃ© CritÃ¨res de Validation Finale

| # | CritÃ¨re Global | ImplÃ©mentÃ© | Status |
|---|----------------|------------|--------|
| 1 | Fichier complet et structurÃ© selon template | âœ… OK | âœ… |
| 2 | MÃ©tadata YAML valide | âœ… OK | âœ… |

**RÃ©sultat CritÃ¨res Globaux** : âœ… PASS (2/2 critÃ¨res validÃ©s)

---
```

---

## ğŸ¯ RÃ©sumÃ© des Changements

### Variables workflow (execute-plan-phase.md)

**AVANT** :
```
checklist_niveau_2 (liste strings)
document_type (string)
strategie (string)
```

**APRÃˆS** :
```
plan_details (markdown complet)
document_type (string) - extrait du plan
strategie (string) - extrait du plan
```

### Prompts agents

**AVANT** :
```
CODE/DOCUMENT : checklist_niveau_2
TEST : checklist_niveau_1 + checklist_niveau_2
```

**APRÃˆS** :
```
CODE/DOCUMENT : plan_details + (checklist assignÃ©e si parallÃ¨le)
TEST : checklist_niveau_1 + plan_details
```

### Validation TEST

**AVANT** :
```
1. Niveau 1 (PLAN.md macro)
2. Niveau 2 (checklist dÃ©taillÃ©e)
3. Tests techniques
```

**APRÃˆS** :
```
1. Niveau 1 (PLAN.md macro)
2. Niveau 2 (checklist dÃ©taillÃ©e depuis plan)
3. CritÃ¨res Validation Finale (depuis plan) â† NOUVEAU
4. Tests techniques
```

---

## âœ… BÃ©nÃ©fices Attendus

### Court terme
1. **Aucune perte d'information** : Plan complet transmis Ã  tous les agents
2. **Agents mieux informÃ©s** : Connaissent risques (Points Attention) et objectifs (CritÃ¨res Validation)
3. **Validations complÃ¨tes** : TEST valide 4 niveaux (macro, dÃ©tail, critÃ¨res globaux, tests techniques)

### Moyen terme
4. **QualitÃ© amÃ©liorÃ©e** : Agents respectent contraintes dÃ¨s implÃ©mentation
5. **Moins d'itÃ©rations** : CritÃ¨res globaux connus dÃ¨s le dÃ©part
6. **Debugging facilitÃ©** : Plan complet visible dans contexte agents

### Long terme
7. **Ã‰volutif** : Ajouter sections au plan (ex: "Dependencies", "Performance Goals") sans casser workflow
8. **Maintenable** : Parsing minimal (metadata orchestration uniquement)
9. **CohÃ©rent** : Tous agents travaillent avec la mÃªme vision globale

---

## ğŸš€ Ordre d'Application

### Phase 1 : Workflow orchestration
1. Modifier `execute-plan-phase.md` Ã‰TAPE 5 (parsing simplifiÃ©)
2. Modifier `execute-plan-phase.md` Ã‰TAPE 6 (prompts CODE/DOCUMENT)
3. Modifier `execute-plan-phase.md` Ã‰TAPE 7 (prompt TEST)

### Phase 2 : Agents exÃ©cution
4. Modifier `code.md` (rÃ©ception contexte + process)
5. Modifier `document.md` (rÃ©ception contexte + process)

### Phase 3 : Agent validation
6. Modifier `test.md` (rÃ©ception contexte + process + rapport)

### Phase 4 : Validation
7. Tester workflow avec Story 5 (phase 4.6 PLAN.md)
8. VÃ©rifier que plan complet est bien transmis et utilisÃ©
9. Valider que TEST vÃ©rifie bien les 4 niveaux

---

## ğŸ“ Notes Importantes

**CompatibilitÃ© ascendante** :
- Stories dÃ©jÃ  rÃ©alisÃ©es (1-4) : Aucun impact (dÃ©jÃ  committÃ©es)
- Stories futures (5+) : BÃ©nÃ©ficient du refactoring

**Risques identifiÃ©s** :
- âš ï¸ Parsing metadata peut Ã©chouer si format plan non-standard â†’ Ajouter validation format
- âš ï¸ Plan trop long (>10KB markdown) â†’ Acceptable, agents LLM gÃ¨rent bien

**Alternatives considÃ©rÃ©es et rejetÃ©es** :
- âŒ Option A (agents parsent eux-mÃªmes) : ComplexitÃ© dÃ©placÃ©e, duplication parsing
- âŒ Option B (workflow parse tout) : Parsing complexe, risque perte info
- âœ… Option C (hybride) : Meilleur compromis simplicitÃ©/complÃ©tude

---

**Date crÃ©ation** : 2025-11-19
**Statut** : âœ… **APPLIQUÃ‰ ET VALIDÃ‰**
**Date application** : 2025-11-19

---

## ğŸ“ ADDENDUM : ComplÃ©tion Points d'Attention (2025-11-19)

### ProblÃ¨me IdentifiÃ© Post-Refactoring

AprÃ¨s application du refactoring principal, audit a rÃ©vÃ©lÃ© :
- âœ… Agent CODE vÃ©rifie Points d'Attention (lignes 103-108 code.md)
- âœ… Agent DOCUMENT vÃ©rifie Points d'Attention (lignes 161-166 document.md)
- âŒ Agent TEST **ne validait PAS** les Points d'Attention (manquait Ã‰TAPE 2B)

**IncohÃ©rence** : CODE/DOCUMENT vÃ©rifient pendant implÃ©mentation, mais TEST ne valide pas aprÃ¨s coup.

### Solution AppliquÃ©e

**Ajout Ã‰TAPE 2B dans agent TEST** ([test.md:92-107](d:\Desktop\flight-search-api\.claude\agents\test.md#L92-L107)) :

```markdown
**Ã‰TAPE 2B : Validation Points d'Attention**

**PrÃ©-requis** : Niveau 1 âœ… PASS + Niveau 2 âœ… PASS

**Extraire Points d'Attention depuis `plan_details`** :
- Rechercher section `## ğŸ” Points d'Attention`
- Parser tous les points listÃ©s

Pour chaque Point d'Attention :
1. Comprendre le risque/contrainte mentionnÃ©
2. VÃ©rifier si pris en compte dans implÃ©mentation
3. Marquer âœ… ou âš ï¸

**RÃ©sultat** :
- Si AU MOINS 1 point non respectÃ© â†’ âš ï¸ Warning (pas bloquant)
- Si TOUS points respectÃ©s â†’ âœ… Bonus qualitÃ©
```

### Modifications ComplÃ¨tes

#### 1. Agent TEST (test.md)

**Ligne 35** : Titre section
```markdown
AVANT : ### 1. Validation Ã  2 Niveaux
APRÃˆS : ### 1. Validation Ã  5 Niveaux (PRIORITÃ‰ STRICTE)
```

**Lignes 92-107** : Ajout Ã‰TAPE 2B (Points d'Attention)
- Validation dÃ©diÃ©e Points d'Attention
- Parsing section `## ğŸ” Points d'Attention`
- RÃ©sultat âœ… PASS ou âš ï¸ WARNINGS

**Lignes 234-245** : Ajout section rapport
```markdown
## âš ï¸ ConformitÃ© Points d'Attention

| # | Point d'Attention | RespectÃ© | Status |
|---|-------------------|----------|--------|
| 1 | [Risque/contrainte] | âœ… / âš ï¸ | âœ… / âš ï¸ |

**RÃ©sultat Points d'Attention** : âœ… PASS | âš ï¸ WARNINGS
```

**Ligne 268** : DÃ©cision Finale PASS
```markdown
AVANT : 4 niveaux listÃ©s
APRÃˆS : 5 niveaux listÃ©s (+ Points d'Attention)
```

**Lignes 382-388** : Exemple Story 5
```markdown
## âš ï¸ ConformitÃ© Points d'Attention

| # | Point d'Attention | RespectÃ© | Status |
|---|-------------------|----------|--------|
| 1 | Respecter template TEMPLATE_SPECS.md strictement | âœ… Template suivi | âœ… |

**RÃ©sultat Points d'Attention** : âœ… PASS (1/1 point respectÃ©)
```

**Lignes 424-442** : Messages finaux
```markdown
Si FAIL niveau 1 :
+ â­ï¸ Points d'Attention : Validation skippÃ©e  (ligne 429)

Si FAIL niveau 2 :
+ â­ï¸ Points d'Attention : Validation skippÃ©e  (ligne 439)
```

#### 2. Workflow (execute-plan-phase.md)

**Lignes 491-496** : Prompt TEST - PrioritÃ©s
```markdown
AVANT : 4 niveaux (PRIORITÃ‰ 1-4)
APRÃˆS : 5 niveaux (+ PRIORITÃ‰ 4 : Points d'Attention)
```

**Ligne 502** : Message retour
```markdown
AVANT : "4 niveaux de validation"
APRÃˆS : "5 niveaux de validation"
```

**Ligne 507** : RÃ©sultat attendu
```markdown
AVANT : 4 validations
APRÃˆS : + points d'attention
```

### HiÃ©rarchie Finale 5 Niveaux

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NIVEAU 1 : Checklist Niveau 1 (Macro)      â”‚
â”‚ â†’ Bloquant (chemins fichiers exacts)       â”‚
â”‚ â†’ Si FAIL : STOP tout                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NIVEAU 2 : Checklist Niveau 2 (DÃ©tail)     â”‚
â”‚ â†’ Bloquant (contenu dÃ©taillÃ©)              â”‚
â”‚ â†’ Si FAIL : Skip niveaux 3, 4, 5           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NIVEAU 3 : CritÃ¨res de Validation Finale   â”‚
â”‚ â†’ Non-bloquant (objectifs globaux)         â”‚
â”‚ â†’ Si FAIL : âš ï¸ Warning (pas bloquant)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NIVEAU 4 : Points d'Attention               â”‚  â† AJOUTÃ‰
â”‚ â†’ Non-bloquant (risques/contraintes)       â”‚
â”‚ â†’ Si FAIL : âš ï¸ Warning (pas bloquant)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NIVEAU 5 : Tests Techniques                â”‚
â”‚ â†’ Bloquant (lint, format, tests)           â”‚
â”‚ â†’ Si FAIL : âŒ Phase Ã©chouÃ©e               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Audit Complet Ultra-DÃ©taillÃ©

**Status** : âœ… **100% FONCTIONNEL ET COHÃ‰RENT**

**Tests effectuÃ©s** :
1. âœ… Flux de donnÃ©es (variables workflow â†’ agents)
2. âœ… Structure plan_details (gÃ©nÃ©ration PLAN â†’ parsing TEST)
3. âœ… HiÃ©rarchie 5 niveaux (workflow prompt â†” agent implÃ©mentation)
4. âœ… Logique skip (FAIL scenarios cohÃ©rents)
5. âœ… Alignement agents (CODE/DOCUMENT/TEST vÃ©rifient tous Points d'Attention)
6. âœ… Format rapport (5 sections complÃ¨tes)
7. âœ… Mode PARALLÃˆLE (checklist optionnelle gÃ©rÃ©e)
8. âœ… Instructions workflow (prompt complet 5 niveaux)

**RÃ©sultat** : Aucune incohÃ©rence dÃ©tectÃ©e, systÃ¨me prÃªt production.

---

**Fichiers modifiÃ©s** :
- `.claude/agents/test.md` (ajout Ã‰TAPE 2B + section rapport + messages skip)
- `.claude/commands/execute-plan-phase.md` (prompt TEST 5 niveaux)

**Impact** : ComplÃ©tion du refactoring avec validation Points d'Attention cohÃ©rente sur tous les agents.
